import{j as e,r as m,b as oe}from"./index-A6i-DHi-.js";import{a as Ue,b as Qe,c as Ke,u as We,d as Ge}from"./breakdown-e_BZ7wx5.js";import{c as Ye,u as le,a as Ze,b as de,B as b}from"./index-BAaPsPyw.js";import{c as v,f as M}from"./utils-B5n6x0oC.js";import{l as Je,S as Xe,a as et,b as tt,c as st,d as L,k as H,P as ce,T as G,f as Y,g as C,h as x,i as Z,j as u,E as at}from"./zodSchemas-CaNjZJV8.js";import{f as me,R as rt,P as nt,W as it,g as ot,C as lt,h as dt,T as ct,i as mt,j as ue,O as ut,k as xt,d as pt,D as ee,a as te,b as se,c as ae,e as re}from"./dialog-tRxNgY05.js";import{u as ht,a as jt,L as g,I as f}from"./label-COEXJ-nk.js";import{u as J,a as X}from"./axiosClient-oslsaWBi.js";import{C as V,a as z,b as U,c as Q,d as K}from"./card-DZRAyplg.js";import{c as F}from"./createLucideIcon-CAhHQjTK.js";import{W as gt}from"./wrench-uNd5Jq0_.js";/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ft=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]],ne=F("calendar",ft);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yt=[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],xe=F("clock",yt);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _t=[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]],pe=F("dollar-sign",_t);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vt=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]],ie=F("file-text",vt);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nt=[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["polyline",{points:"3.29 7 12 12 20.71 7",key:"ousv84"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]],he=F("package",Nt);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bt=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],je=F("trash-2",bt),wt=Ye("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground",success:"border-transparent bg-green-500 text-white hover:bg-green-600",warning:"border-transparent bg-yellow-500 text-white hover:bg-yellow-600"}},defaultVariants:{variant:"default"}});function k({className:s,variant:t,...a}){return e.jsx("div",{className:v(wt({variant:t}),s),...a})}var ge="AlertDialog",[kt,ls]=ot(ge,[me]),w=me(),fe=s=>{const{__scopeAlertDialog:t,...a}=s,c=w(t);return e.jsx(rt,{...c,...a,modal:!0})};fe.displayName=ge;var Dt="AlertDialogTrigger",At=m.forwardRef((s,t)=>{const{__scopeAlertDialog:a,...c}=s,d=w(a);return e.jsx(xt,{...d,...c,ref:t})});At.displayName=Dt;var Ct="AlertDialogPortal",ye=s=>{const{__scopeAlertDialog:t,...a}=s,c=w(t);return e.jsx(nt,{...c,...a})};ye.displayName=Ct;var St="AlertDialogOverlay",_e=m.forwardRef((s,t)=>{const{__scopeAlertDialog:a,...c}=s,d=w(a);return e.jsx(ut,{...d,...c,ref:t})});_e.displayName=St;var P="AlertDialogContent",[Pt,Ft]=kt(P),Tt=Ze("AlertDialogContent"),ve=m.forwardRef((s,t)=>{const{__scopeAlertDialog:a,children:c,...d}=s,n=w(a),h=m.useRef(null),y=le(t,h),N=m.useRef(null);return e.jsx(it,{contentName:P,titleName:Ne,docsSlug:"alert-dialog",children:e.jsx(Pt,{scope:a,cancelRef:N,children:e.jsxs(lt,{role:"alertdialog",...n,...d,ref:y,onOpenAutoFocus:dt(d.onOpenAutoFocus,p=>{p.preventDefault(),N.current?.focus({preventScroll:!0})}),onPointerDownOutside:p=>p.preventDefault(),onInteractOutside:p=>p.preventDefault(),children:[e.jsx(Tt,{children:c}),e.jsx(Rt,{contentRef:h})]})})})});ve.displayName=P;var Ne="AlertDialogTitle",be=m.forwardRef((s,t)=>{const{__scopeAlertDialog:a,...c}=s,d=w(a);return e.jsx(ct,{...d,...c,ref:t})});be.displayName=Ne;var we="AlertDialogDescription",ke=m.forwardRef((s,t)=>{const{__scopeAlertDialog:a,...c}=s,d=w(a);return e.jsx(mt,{...d,...c,ref:t})});ke.displayName=we;var Bt="AlertDialogAction",De=m.forwardRef((s,t)=>{const{__scopeAlertDialog:a,...c}=s,d=w(a);return e.jsx(ue,{...d,...c,ref:t})});De.displayName=Bt;var Ae="AlertDialogCancel",Ce=m.forwardRef((s,t)=>{const{__scopeAlertDialog:a,...c}=s,{cancelRef:d}=Ft(Ae,a),n=w(a),h=le(t,d);return e.jsx(ue,{...n,...c,ref:h})});Ce.displayName=Ae;var Rt=({contentRef:s})=>{const t=`\`${P}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${P}\` by passing a \`${we}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${P}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return m.useEffect(()=>{document.getElementById(s.current?.getAttribute("aria-describedby"))||console.warn(t)},[t,s]),null},Mt=fe,Et=ye,Se=_e,Pe=ve,Fe=De,Te=Ce,Be=be,Re=ke;const Ot=Mt,qt=Et,Me=m.forwardRef(({className:s,...t},a)=>e.jsx(Se,{className:v("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...t,ref:a}));Me.displayName=Se.displayName;const Ee=m.forwardRef(({className:s,...t},a)=>e.jsxs(qt,{children:[e.jsx(Me,{}),e.jsx(Pe,{ref:a,className:v("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",s),...t})]}));Ee.displayName=Pe.displayName;const Oe=({className:s,...t})=>e.jsx("div",{className:v("flex flex-col space-y-2 text-center sm:text-left",s),...t});Oe.displayName="AlertDialogHeader";const qe=({className:s,...t})=>e.jsx("div",{className:v("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",s),...t});qe.displayName="AlertDialogFooter";const Ie=m.forwardRef(({className:s,...t},a)=>e.jsx(Be,{ref:a,className:v("text-lg font-semibold",s),...t}));Ie.displayName=Be.displayName;const $e=m.forwardRef(({className:s,...t},a)=>e.jsx(Re,{ref:a,className:v("text-sm text-muted-foreground",s),...t}));$e.displayName=Re.displayName;const Le=m.forwardRef(({className:s,...t},a)=>e.jsx(Fe,{ref:a,className:v(de(),s),...t}));Le.displayName=Fe.displayName;const He=m.forwardRef(({className:s,...t},a)=>e.jsx(Te,{ref:a,className:v(de({variant:"outline"}),"mt-2 sm:mt-0",s),...t}));He.displayName=Te.displayName;const W=m.forwardRef(({className:s,...t},a)=>e.jsx("textarea",{className:v("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),ref:a,...t}));W.displayName="Textarea";const It=(s,t)=>X({url:"/api/breakdown-parts",method:"POST",headers:{"Content-Type":"application/json"},data:s,signal:t}),$t=s=>{const t=["createBreakdownPart"],{mutation:a}={mutation:{mutationKey:t}};return{mutationFn:d=>{const{data:n}=d??{};return It(n)},...a}},Lt=s=>{const t=$t();return J(t)},Ht=(s,t)=>X({url:`/api/breakdown-parts/${s}`,method:"PUT",headers:{"Content-Type":"application/json"},data:t}),Vt=s=>{const t=["updateBreakdownPart"],{mutation:a}={mutation:{mutationKey:t}};return{mutationFn:d=>{const{id:n,data:h}=d??{};return Ht(n,h)},...a}},zt=s=>{const t=Vt();return J(t)},Ut=s=>X({url:`/api/breakdown-parts/${s}`,method:"DELETE"}),Qt=s=>{const t=["deleteBreakdownPart"],{mutation:a}={mutation:{mutationKey:t}};return{mutationFn:d=>{const{id:n}=d??{};return Ut(n)},...a}},Kt=s=>{const t=Qt();return J(t)},Wt=Je;function Gt({machineId:s,breakdown:t,onSuccess:a,onCancel:c}){const d=oe(),[n,h]=m.useState([]),[y,N]=m.useState(null),[p,D]=m.useState({part_name:"",part_number:"",quantity:1,unit_cost:0}),_=m.useMemo(()=>t?.parts||[],[t]);m.useEffect(()=>{t&&_.length>0&&h(_.map(l=>({id:l.id,part_name:l.part_name,part_number:l.part_number||"",quantity:l.quantity,unit_cost:l.unit_cost,total_cost:l.total_cost})))},[t,_]);const T=Ue({mutation:{onSuccess:async()=>{d.invalidateQueries({queryKey:["/api/breakdowns"]}),d.invalidateQueries({queryKey:["/api/breakdown-parts"]}),a()}}}),B=Qe({mutation:{onSuccess:async()=>{if(t){delete t.machine;for(const r of n)r.isNew?await E.mutateAsync({data:{part_name:r.part_name,part_number:r.part_number,quantity:r.quantity,unit_cost:r.unit_cost,total_cost:r.total_cost,breakdown_id:t.id||"",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}}):r.id&&await O.mutateAsync({id:r.id,data:{...r,part_name:r.part_name,part_number:r.part_number,quantity:r.quantity,unit_cost:r.unit_cost,total_cost:r.total_cost,breakdown_id:t.id||""}});const l=n.filter(r=>r.id).map(r=>r.id);for(const r of _)l.includes(r.id)||await q.mutateAsync({id:r.id||""})}d.invalidateQueries({queryKey:["/api/breakdowns"]}),d.invalidateQueries({queryKey:["/api/breakdown-parts"]}),a()}}}),E=Lt(),O=zt(),q=Kt(),i=ht({resolver:jt(Wt),defaultValues:t?{...t,breakdown_name:t.breakdown_name,reason:t.reason,planned_date:t.planned_date,completed_date:t.completed_date||"",labour_cost:t.labour_cost,repair_time_hours:t.repair_time_hours,service_report:t.service_report||"",status:t.status,breakdown_number:t.breakdown_number}:{breakdown_name:"",reason:"",planned_date:new Date().toISOString(),completed_date:"",labour_cost:0,repair_time_hours:0,service_report:"",status:"pending",attended_by:"",certified_by:"",created_at:new Date().toISOString(),created_by_id:"",total_cost:0,updated_at:new Date().toISOString(),machine_id:s,breakdown_number:0}}),I=async l=>{try{const r=n.reduce((A,ze)=>A+ze.total_cost,0),R={...l,machine_id:s,total_cost:r||0,parts:t?void 0:n.map(A=>({part_name:A.part_name,part_number:A.part_number,quantity:A.quantity,unit_cost:A.unit_cost,total_cost:A.total_cost}))};t?await B.mutateAsync({id:t.id||"",data:R}):await T.mutateAsync({data:R})}catch(r){console.error("Error saving breakdown:",r),alert("Failed to save breakdown. Please try again.")}},o=()=>{const l={...p,total_cost:p.quantity*p.unit_cost,isNew:!0};if(y!==null){const r=[...n];r[y]={...r[y],...l},h(r),N(null)}else h([...n,l]);D({part_name:"",part_number:"",quantity:1,unit_cost:0})},j=l=>{const r=n[l];D({part_name:r.part_name,part_number:r.part_number,quantity:r.quantity,unit_cost:r.unit_cost}),N(l)},S=l=>{h(n.filter((r,R)=>R!==l))},$=n.reduce((l,r)=>l+r.total_cost,0),Ve=i.watch("labour_cost")+$;return console.log(i.control._formState),e.jsxs(e.Fragment,{children:[e.jsxs("form",{id:"breakdown-form",onSubmit:i.handleSubmit(I),className:"space-y-4 overflow-y-auto p-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"breakdown_name",children:"Breakdown Type*"}),e.jsx(f,{id:"breakdown_name",...i.register("breakdown_name"),placeholder:"e.g., Motor failure"}),i.formState.errors.breakdown_name&&e.jsx("p",{className:"text-sm text-destructive",children:i.formState.errors.breakdown_name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"status",children:"Status*"}),e.jsxs(Xe,{value:i.watch("status"),onValueChange:l=>i.setValue("status",l),children:[e.jsx(et,{children:e.jsx(tt,{placeholder:"Select status"})}),e.jsxs(st,{children:[e.jsx(L,{value:"pending",children:"Pending"}),e.jsx(L,{value:"in_progress",children:"In Progress"}),e.jsx(L,{value:"completed",children:"Completed"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"",children:"Breakdown On*"}),e.jsx(f,{id:"breakdown_date",type:"date",...i.register("breakdown_date")}),i.formState.errors.breakdown_date&&e.jsx("p",{className:"text-sm text-destructive",children:i.formState.errors.breakdown_date.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"breakdown_time",children:"Breakdown Time*"}),e.jsx(f,{id:"breakdown_time",type:"time",...i.register("breakdown_time")}),i.formState.errors.breakdown_time&&e.jsx("p",{className:"text-sm text-destructive",children:i.formState.errors.breakdown_time.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"planned_date",children:"Planned Date*"}),e.jsx(f,{id:"planned_date",type:"date",...i.register("planned_date")}),i.formState.errors.planned_date&&e.jsx("p",{className:"text-sm text-destructive",children:i.formState.errors.planned_date.message})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"attended_by",children:"Attended By*"}),e.jsx(f,{id:"attended_by",type:"text",placeholder:"Enter name",...i.register("attended_by")}),i.formState.errors.attended_by&&e.jsx("p",{className:"text-sm text-destructive",children:i.formState.errors.attended_by.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"completed_date",children:"Rectified Date"}),e.jsx(f,{id:"completed_date",type:"date",...i.register("completed_date")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"completed_time",children:"Rectified Time*"}),e.jsx(f,{id:"completed_time",type:"time",...i.register("completed_time")}),i.formState.errors.completed_time&&e.jsx("p",{className:"text-sm text-destructive",children:i.formState.errors.completed_time.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"",children:"Certified By"}),e.jsx(f,{id:"certified_by",type:"text",placeholder:"Enter name",...i.register("certified_by")}),i.formState.errors.certified_by&&e.jsx("p",{className:"text-sm text-destructive",children:i.formState.errors.certified_by.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"repair_time_hours",children:"Repair Time (hours)"}),e.jsx(f,{id:"repair_time_hours",type:"number",step:1,placeholder:"Enter repair time in hours",...i.register("repair_time_hours",{valueAsNumber:!0})}),i.formState.errors.repair_time_hours&&e.jsx("p",{className:"text-sm text-destructive",children:i.formState.errors.repair_time_hours.message})]}),e.jsxs("div",{className:"col-span-2 space-y-2",children:[e.jsx(g,{htmlFor:"service_report",children:"Service Report"}),e.jsx(W,{id:"service_report",...i.register("service_report"),placeholder:"Additional notes about the service...",rows:3})]}),e.jsxs("div",{className:"col-span-2 space-y-2",children:[e.jsx(g,{htmlFor:"reason",children:"Reason For Breakdown"}),e.jsx(W,{id:"reason",...i.register("reason"),placeholder:"Reason for breakdown...",rows:3})]})]}),e.jsxs(V,{children:[e.jsxs(z,{children:[e.jsxs(U,{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(he,{className:"w-5 h-5 mr-2"}),"Parts & Components"]}),e.jsxs("span",{className:"text-sm font-normal text-muted-foreground",children:["Total Parts Cost: ₹",$.toFixed(2)]})]}),e.jsx(Q,{children:"Add parts used in this breakdown"})]}),e.jsxs(K,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx(f,{placeholder:"Part name",value:p.part_name,onChange:l=>D({...p,part_name:l.target.value})}),e.jsx(f,{type:"number",placeholder:"Qty",min:"1",value:p.quantity,onChange:l=>D({...p,quantity:parseInt(l.target.value)||1})}),e.jsx(f,{type:"number",placeholder:"Unit cost",step:"0.01",min:"0",value:p.unit_cost,onChange:l=>D({...p,unit_cost:parseFloat(l.target.value)||0})}),e.jsx(b,{type:"button",onClick:o,disabled:!p.part_name||p.unit_cost<=0,size:"sm",children:y!==null?e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"w-4 h-4 mr-1"}),"Update"]}):e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"w-4 h-4 mr-1"}),"Add"]})})]}),n.length>0&&e.jsx("div",{className:"rounded-md border",children:e.jsxs(G,{children:[e.jsx(Y,{children:e.jsxs(C,{children:[e.jsx(x,{children:"Part Name"}),e.jsx(x,{className:"text-right",children:"Qty"}),e.jsx(x,{className:"text-right",children:"Unit Cost"}),e.jsx(x,{className:"text-right",children:"Total"}),e.jsx(x,{className:"text-right",children:"Actions"})]})}),e.jsx(Z,{children:n.map((l,r)=>e.jsxs(C,{children:[e.jsx(u,{children:l.part_name}),e.jsx(u,{className:"text-right",children:l.quantity}),e.jsxs(u,{className:"text-right",children:["₹",l.unit_cost.toFixed(2)]}),e.jsxs(u,{className:"text-right font-medium",children:["₹",l.total_cost.toFixed(2)]}),e.jsx(u,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end space-x-1",children:[e.jsx(b,{type:"button",variant:"ghost",size:"sm",onClick:()=>j(r),children:e.jsx(H,{className:"w-3 h-3"})}),e.jsx(b,{type:"button",variant:"ghost",size:"sm",onClick:()=>S(r),children:e.jsx(je,{className:"w-3 h-3"})})]})})]},r))})]})})]})]}),e.jsx("div",{className:"bg-muted rounded-lg p-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Labour Cost:"}),e.jsxs("span",{children:["₹",Number(i.watch("labour_cost")||0).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Parts Cost:"}),e.jsxs("span",{children:["₹",$.toFixed(2)]})]}),e.jsxs("div",{className:"border-t pt-2 flex justify-between font-semibold",children:[e.jsx("span",{children:"Total Cost:"}),e.jsxs("span",{className:"text-lg",children:["₹",Number(Ve).toFixed(2)]})]})]})})]}),e.jsx(pt,{children:e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(b,{type:"button",variant:"outline",onClick:c,children:"Cancel"}),e.jsx(b,{type:"submit",form:"breakdown-form",disabled:T.isPending||B.isPending,children:T.isPending||B.isPending?"Saving...":t?"Update Breakdown":"Add Breakdown"})]})})]})}function Yt({breakdownId:s}){const{data:t,isLoading:a,error:c}=Ke(s,{populate:"machine,parts"});if(a)return e.jsx("div",{className:"text-center py-8",children:"Loading breakdown details..."});if(c||!t)return e.jsx("div",{className:"text-center py-8 text-destructive",children:"Failed to load breakdown details"});const d=n=>{switch(n){case"pending":return e.jsx(k,{variant:"secondary",children:"Pending"});case"in_progress":return e.jsx(k,{variant:"warning",children:"In Progress"});case"completed":return e.jsx(k,{variant:"success",children:"Completed"});default:return e.jsx(k,{children:n})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(V,{children:[e.jsx(z,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(U,{className:"flex items-center space-x-2",children:[e.jsx(gt,{className:"w-5 h-5"}),e.jsx("span",{children:t.breakdown_name})]}),e.jsxs(Q,{children:["Machine: ",t.machine?.machine_number||"N/A"]})]}),d(t.status)]})}),e.jsxs(K,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center text-sm text-muted-foreground",children:[e.jsx(ne,{className:"w-4 h-4 mr-1"}),"Planned Date"]}),e.jsx("p",{className:"font-medium",children:M(t.planned_date)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center text-sm text-muted-foreground",children:[e.jsx(ne,{className:"w-4 h-4 mr-1"}),"Completed Date"]}),e.jsx("p",{className:"font-medium",children:t.completed_date?M(t.completed_date):"Not completed"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center text-sm text-muted-foreground",children:[e.jsx(xe,{className:"w-4 h-4 mr-1"}),"Repair Time"]}),e.jsxs("p",{className:"font-medium",children:[t.repair_time_hours," hours"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center text-sm text-muted-foreground",children:[e.jsx(pe,{className:"w-4 h-4 mr-1"}),"Labour Cost"]}),e.jsxs("p",{className:"font-medium",children:["₹",t.labour_cost.toFixed(2)]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center text-sm text-muted-foreground",children:[e.jsx(ie,{className:"w-4 h-4 mr-1"}),"Reason"]}),e.jsx("p",{className:"text-sm",children:t.reason})]}),t.service_report&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center text-sm text-muted-foreground",children:[e.jsx(ie,{className:"w-4 h-4 mr-1"}),"Service Report"]}),e.jsx("p",{className:"text-sm",children:t.service_report})]}),e.jsx("div",{className:"pt-4 border-t",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-lg font-semibold",children:"Total Cost:"}),e.jsxs("span",{className:"text-2xl font-bold text-primary",children:["₹",t.total_cost.toFixed(2)]})]})})]})]}),e.jsxs(V,{children:[e.jsx(z,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(U,{className:"flex items-center",children:[e.jsx(he,{className:"w-5 h-5 mr-2"}),"Parts & Components"]}),e.jsx(Q,{children:"Parts used in this breakdown repair"})]}),t.parts&&t.parts.length>0&&e.jsxs("div",{className:"text-lg font-semibold",children:["Total: ₹",t.parts.reduce((n,h)=>n+(h.total_cost||0),0).toFixed(2)]})]})}),e.jsx(K,{children:t.parts&&t.parts.length>0?e.jsx("div",{className:"rounded-md border",children:e.jsxs(G,{children:[e.jsx(Y,{children:e.jsxs(C,{children:[e.jsx(x,{children:"Part Name"}),e.jsx(x,{children:"Part Number"}),e.jsx(x,{className:"text-right",children:"Quantity"}),e.jsx(x,{className:"text-right",children:"Unit Cost"}),e.jsx(x,{className:"text-right",children:"Total Cost"})]})}),e.jsx(Z,{children:t.parts.map(n=>e.jsxs(C,{children:[e.jsx(u,{className:"font-medium",children:n.part_name}),e.jsx(u,{children:n.part_number||"-"}),e.jsx(u,{className:"text-right",children:n.quantity}),e.jsxs(u,{className:"text-right",children:["₹",n.unit_cost.toFixed(2)]}),e.jsxs(u,{className:"text-right font-medium",children:["₹",n.total_cost.toFixed(2)]})]},n.id))})]})}):e.jsx("div",{className:"text-center py-8 text-muted-foreground border rounded-lg",children:"No parts used in this breakdown"})})]})]})}function ds({machineId:s,showMachineColumn:t=!1}){const[a,c]=m.useState(!1),[d,n]=m.useState(null),[h,y]=m.useState(null),[N,p]=m.useState(null),D=oe(),{data:_=[],isLoading:T}=We(s?{populate:"machine,parts",filters:{machine_id:{$eq:s}}}:{populate:"machine,parts"}),B=Ge({mutation:{onSuccess:()=>{D.invalidateQueries({queryKey:["/api/breakdowns"]}),y(null)}}}),E=o=>{n(o),c(!0)},O=()=>{n(null),c(!0)},q=async()=>{if(h)try{await B.mutateAsync({id:h})}catch(o){console.error("Error deleting breakdown:",o),alert("Failed to delete breakdown")}},i=()=>{c(!1),n(null)},I=o=>{switch(o){case"pending":return e.jsx(k,{variant:"secondary",children:"Pending"});case"in_progress":return e.jsx(k,{variant:"warning",children:"In Progress"});case"completed":return e.jsx(k,{variant:"success",children:"Completed"});default:return e.jsx(k,{children:o})}};return T?e.jsx("div",{className:"text-center py-8",children:"Loading breakdowns..."}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold",children:s?"Machine Breakdowns":"All Breakdowns"}),s&&e.jsxs(b,{onClick:O,size:"sm",children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"Add Breakdown"]})]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(G,{children:[e.jsx(Y,{children:e.jsxs(C,{children:[t&&e.jsx(x,{children:"Machine"}),e.jsx(x,{children:"Breakdown Date"}),e.jsx(x,{children:"Breakdown Time"}),e.jsx(x,{children:"Breakdown Number"}),e.jsx(x,{children:"Breakdown Type"}),e.jsx(x,{children:"Status"}),e.jsx(x,{children:"Attended By"}),e.jsx(x,{children:"Planned Date"}),e.jsx(x,{children:"Rectified Date"}),e.jsx(x,{children:"Rectified Time"}),e.jsx(x,{children:"Certified By"}),e.jsx(x,{className:"min-w-[250px]",children:"Parts Used"}),e.jsx(x,{children:"Reason For Breakdown"}),e.jsx(x,{className:"text-right",children:"Actions"})]})}),e.jsx(Z,{children:_.length===0?e.jsx(C,{children:e.jsx(u,{colSpan:t?8:7,className:"text-center text-muted-foreground",children:"No breakdowns found"})}):_.map(o=>e.jsxs(C,{children:[t&&e.jsx(u,{className:"font-medium",children:o.machine?.machine_number||"-"}),e.jsx(u,{className:"font-medium",children:o.breakdown_date}),e.jsx(u,{children:o.breakdown_time}),e.jsx(u,{children:o.breakdown_number}),e.jsx(u,{children:o.breakdown_name}),e.jsx(u,{children:I(o.status)}),e.jsx(u,{children:o.attended_by}),e.jsx(u,{children:M(o.planned_date)}),e.jsx(u,{children:M(o.completed_date||"")}),e.jsx(u,{children:o.completed_time}),e.jsx(u,{children:o.certified_by}),e.jsx(u,{children:o.parts&&o.parts.length>0?e.jsxs("div",{className:"space-y-1",children:[o.parts.map((j,S)=>e.jsxs("div",{className:`text-sm p-1 rounded ${S%2===0?"bg-muted/30":""}`,children:[e.jsx("div",{className:"font-medium",children:j.part_name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[j.part_number&&e.jsxs("span",{children:[j.part_number," • "]}),"Qty: ",j.quantity," × ₹",j.unit_cost.toFixed(2)," = ₹",j.total_cost.toFixed(2)]})]},S)),e.jsx("div",{className:"pt-1 border-t",children:e.jsxs("div",{className:"text-xs font-medium",children:["Total Parts: ₹",o.parts.reduce((j,S)=>j+(S.total_cost||0),0).toFixed(2)]})})]}):e.jsx("span",{className:"text-muted-foreground text-sm",children:"No parts"})}),e.jsx(u,{children:o.reason}),e.jsx(u,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end space-x-1",children:[e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>o.id&&p(o.id),title:"View Details & Parts",children:e.jsx(at,{className:"w-4 h-4"})}),e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>E(o),title:"Edit Breakdown",children:e.jsx(H,{className:"w-4 h-4"})}),e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>o.id&&y(o.id),title:"Delete Breakdown",children:e.jsx(je,{className:"w-4 h-4"})})]})})]},o.id))})]})}),_.length>0&&e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-4",children:[e.jsxs("div",{className:"bg-card rounded-lg p-4 border",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Total Cost"}),e.jsx(pe,{className:"w-4 h-4 text-muted-foreground"})]}),e.jsxs("p",{className:"text-2xl font-bold",children:["₹",_.reduce((o,j)=>o+Number(j.total_cost),0).toFixed(2)]})]}),e.jsxs("div",{className:"bg-card rounded-lg p-4 border",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Total Hours"}),e.jsx(xe,{className:"w-4 h-4 text-muted-foreground"})]}),e.jsxs("p",{className:"text-2xl font-bold",children:[_.reduce((o,j)=>o+j.repair_time_hours,0),"h"]})]})]}),s&&e.jsx(ee,{open:a,onOpenChange:c,children:e.jsxs(te,{className:"max-w-4xl  max-h-[80vh] h-full",children:[e.jsxs(se,{children:[e.jsx(ae,{children:d?"Edit Breakdown":"Add New Breakdown"}),e.jsx(re,{children:d?"Update the breakdown details below.":"Fill in the details to add a new breakdown."})]}),e.jsx(Gt,{machineId:s,breakdown:d||void 0,onSuccess:i,onCancel:()=>c(!1)})]})}),e.jsx(Ot,{open:!!h,onOpenChange:()=>y(null),children:e.jsxs(Ee,{children:[e.jsxs(Oe,{children:[e.jsx(Ie,{children:"Are you sure?"}),e.jsx($e,{children:"This action cannot be undone. This will permanently delete the breakdown record."})]}),e.jsxs(qe,{children:[e.jsx(He,{children:"Cancel"}),e.jsx(Le,{onClick:q,children:"Delete"})]})]})}),e.jsx(ee,{open:!!N,onOpenChange:()=>p(null),children:e.jsxs(te,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(se,{children:[e.jsx(ae,{children:"Breakdown Details"}),e.jsx(re,{children:"Complete breakdown information including parts used"})]}),N&&e.jsx(Yt,{breakdownId:N})]})})]})}export{ds as B,ne as C,k as a};
